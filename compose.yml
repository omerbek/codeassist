services:
  ollama:
    container_name: codeassist-ollama
    image: ollama/ollama:0.11.10
    networks:
      - codeassist_network
    ports:
      - "11434:11434"
    volumes:
      - ./ollama-data:/root/.ollama

  web-ui:
    container_name: codeassist-web-ui
    build:
      context: ./web-ui
      args:
        - NEXT_PUBLIC_TESTER_URL=/api/tester
        - NEXT_PUBLIC_STATE_SERVICE_URL=/api/backend
        - NEXT_PUBLIC_POLICY_MODELS_URL=/api/policy
        - NEXT_PUBLIC_ALCHEMY_API_KEY=wvs3CE89g2JwoshNNCMe1
    networks:
      - codeassist_network
    ports:
      - "3000:3000"
    volumes:
      - ./persistent-data:/app/persistent-data
    environment:
      - PERSISTENT_DATA_DIR=/app/persistent-data

  simulation-ui:
    container_name: codeassist-simulation-ui
    build:
      context: ./web-ui
      args:
        - NEXT_PUBLIC_TESTER_URL=/api/tester
        - NEXT_PUBLIC_STATE_SERVICE_URL=/api/backend
        - NEXT_PUBLIC_POLICY_MODELS_URL=/api/policy
        - NEXT_PUBLIC_SIMULATION_MODE=true
        - NEXT_PUBLIC_ALCHEMY_API_KEY=wvs3CE89g2JwoshNNCMe1
    networks:
      - codeassist_network
    ports:
      - "3002:3000"
    volumes:
      - ./persistent-data:/app/persistent-data
    environment:
      - PERSISTENT_DATA_DIR=/app/persistent-data

  zero-style-ui:
    container_name: codeassist-zero-style-ui
    build:
      context: ./web-ui
      args:
        - NEXT_PUBLIC_TESTER_URL=/api/tester
        - NEXT_PUBLIC_STATE_SERVICE_URL=/api/backend
        - NEXT_PUBLIC_POLICY_MODELS_URL=/api/policy
        - NEXT_PUBLIC_ZERO_STYLE_MODE=true
    networks:
      - codeassist_network
    ports:
      - "3003:3000"
    volumes:
      - ./persistent-data:/app/persistent-data
    environment:
      - PERSISTENT_DATA_DIR=/app/persistent-data

  state-service:
    container_name: codeassist-state-service
    build: ./state-service
    networks:
      - codeassist_network
    ports:
      - "8000:8000"
    volumes:
      - ./persistent-data:/app/persistent-data
      - ./datasets:/app/datasets
    environment:
      - OLLAMA_BASE_URL=http://codeassist-ollama:11434
      - OLLAMA_HOST=http://codeassist-ollama:11434
      - PERSISTENT_DATA_DIR=/app/persistent-data
      - SOLUTION_TESTER_BASE_URL=http://codeassist-solution-tester:8008
      - POLICY_MODEL_BASE_URL=http://codeassist-policy-model:8001
      - TELEMETRY_BASE_URL=http://telemetry-api.telemetry-api-staging.svc.internal-apps-central1.clusters.gensyn.ai

  solution-tester:
    container_name: codeassist-solution-tester
    build: ./solution-tester
    networks:
      - codeassist_network
    ports:
      - "8008:8008"
    volumes:
      - ./persistent-data:/app/persistent-data
  
  policy-models:
    container_name: codeassist-policy-model
    build: ./policy_models
    networks:
      - codeassist_network
    ports:
      - "8001:8001"
    volumes:
      - ./persistent-data:/app/persistent-data
    environment:
      - DEVICE=cpu
      - OLLAMA_BASE_URL=http://codeassist-ollama:11434
      - OLLAMA_HOST=http://codeassist-ollama:11434
      - PERSISTENT_DATA_DIR=/app/persistent-data
      - ASM_ASSISTANT_MODEL_PATH=/app/persistent-data/trainer/models/asm_assistant_model.pt
      - ASM_FEATURIZER_PATH=/app/persistent-data/trainer/models/asm_featurizer.pt
      - ASM_HUMAN_MODEL_PATH=/app/persistent-data/trainer/models/asm_assistant_model.pt

networks:
  codeassist_network: {}